<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>2016 Presidential Election Influence - powered by Splunk</title>
    <meta name="description" content="Splunk">
    <meta name="author" content="Satoshi Kawasaki">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link href="css/grayscale.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">

    <base target="_blank">
</head>
<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
                    Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">
                    <span class="light">Splunk &gt;</span>
                </a>
            </div>

            <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
                <ul class="nav navbar-nav">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#data">Data</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#how">How</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#technical">Technical</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#contact">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
   </nav>

    <header class="intro">
        <div class="intro-body">
            <div class="container">
                <div class="row">
                    <div class="col-md-8 col-md-offset-2">
                        <h1 class="brand-heading">Clinton vs Trump</h1>
                        <p class="intro-text">2016 Presidential Election Influence</p>
                        <p>Latest data: <span id="latest"></span> (updated <span id="updated"></span>)</p>
                        <a href="#about" class="btn btn-circle page-scroll">
                            <i class="fa fa-angle-double-down animated"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section id="about" class="container content-section text-justify">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <h2 class="text-center"><span id="total"></span> of independent expenditures spent (so far)</h2>
                <p>Presidential elections in the United States are always contentious. A battle of ideas for arguably the most powerful position in the planet more than justifies it. But the influence of money in these elections has become a source of great frustration.</p>
                <p>The disproportionate influence of independent expenditures has always been controversial, but until relatively recently those dollars were all reported – who and where the money came from, how the money was spent, which candidate benefited from that spending. But since the <a href="https://en.wikipedia.org/wiki/Citizens_United_v._FEC"><em>Citizens United v. Federal Elections Commission</em></a> decision in 2010, the rise of independent spending by so-called "<a href="https://en.wikipedia.org/wiki/Political_action_committee#Super_PACs">Super PACs</a>" in these elections – with no reporting on who or where the money comes from – has risen to historic levels. So, how much money is truly being spent by these Super PACs? And who is winning the "independent" campaign?</p>
                <p>As a follow-up to the Splunk FEC Explorer App in the 2012 election, this 2016 Presidential Election Influence explorer focuses on the flow of soft money. Who is spending for and against Clinton? Who is spending for and against Trump?<!-- And most importantly, how much are they spending over time?--> And we get the data to you in real-time using Splunk.</p>
            </div>
        </div>
    </section>

    <section id="data" class="container content-section text-justify">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <h2 class="text-center">The wonderful data</h2>
            </div>
        </div>
    </section>
    <svg id="viz_timecharts" class="center"></svg>
    <section class="container content-section text-justify no-padding-top">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <p>Overall, independent expenditures in 2016 have indicated an overwhelmingly negative race, and Super-PAC spending has comprised a significant amount of that spending. However, that is not necessarily the case for both candidates. More than <span id="factor"></span> times the amount of spending has been directed toward Trump than toward Clinton, but the majority of that spending was spent in opposition. Independent spending on Clinton in the election to date has been roughly even for and against.</p>
                <p class="small text-center">Hover over each chart for more details.</p>
            </div>
        </div>
    </section>
   <svg id="viz_pies" class="center"></svg>
    <section class="container content-section text-justify no-padding-top">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <p>But how is the money flowing in the race? Who is spending for and against each candidate? A bigger picture can be created by looking at the top spending committees (mostly Super PACs) supporting and opposing the presidential candidates in the chart below. The top 5 most-spending committees are shown per candidate per action (supporting or opposing).</p>
                <p class="small text-center">Select from the buttons below to filter between supporting and opposing causes. Committee names in italics aren't Super PACs.</p>
                <div class="text-center">
                    <div id="toward_controls" class="btn-group" role="group">
                        <button class="btn btn-blue" value="both">Show both</button>
                        <button class="btn btn-green" value="supporting">Show only supporting</button>
                        <button class="btn btn-red" value="opposing">Show only opposing</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <svg id="viz_halo" class="center"></svg>

    <section id="how" class="container content-section text-justify">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <h2 class="text-center">How the data flows</h2>
                <p>The Federal Elections Commission has for many years made data available on the funding of presidential elections in the United States. Data is readily available on the <a href="https://beta.fec.gov/">FEC website</a> on who, what, and from where direct contributions are coming into candidates. You can ask questions, search names, and even look at this all on pretty maps. What is harder to find, however, is accessible information on Super-PACs. And that’s where Splunk comes in.</p>
                <p>We have linked up to the latest FEC reports directly via the <a href="https://beta.fec.gov/">OpenFEC API (beta)</a>, where we get access to the latest contributions and spending data as soon as the data is updated. Ingesting into Splunk is easy and anyone can visualize the data themselves. Splunk has a number of out-of-the-box visualizations available, or you can design your own in d3 or other visualization libraries. The data displayed above is called "Halo" and is built using <a href="https://d3js.org/">d3.js</a>, and will soon be available for use in your own project in <a href="https://splunkbase.splunk.com/">Splunkbase</a>.</p>
            </div>
        </div>
    </section>

    <section id="technical" class="container content-section text-justify">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <h2 class="text-center">The technical discussion</h2>
                <p class="small text-center">by Satoshi Kawasaki</p>
                <p>We used the <a href="https://beta.fec.gov/data/">OpenFEC site</a> to figure out Clinton and Trump's candidate ID as <code>P00003392</code> and <code>P80001571</code>, respectively.</p>
                <p>The API endpoint for independent expenditures is called <a href="https://api.open.fec.gov/developers/#!/independent_expenditures">Schedule E</a>. An example endpoint is</p>
                <p><a href="https://api.open.fec.gov/v1/schedules/schedule_e/?last_index=0&per_page=100&api_key=DEMO_KEY&candidate_id=P00003392">https://api.open.fec.gov/v1/schedules/schedule_e/?last_index=0&per_page=100&api_key=DEMO_KEY&candidate_id=P00003392</a>.</p>
                <p>Each response returns a value called <code>last_index</code> that is needed to paginate through the full result set. So to get all the results, we wrote a Python script on the Splunk server (different from this web server) to store and keep track of <code>last_index</code> and write the response to a file. The script also runs every hour to update the file and add new entries.</p>
                <p>Each response has up to 100 independent expenditure transactions, and we wanted each transaction to be its own individual event in Splunk. Using trial-and-error, we created <code>props.conf</code> and <code>transforms.conf</code> for Splunk to be the following:</p>
<pre># props.conf
[fec_schedule_e]
LINE_BREAKER = (\[|,|\R){
TRUNCATE = 5000
SHOULD_LINEMERGE = false
TIME_PREFIX = "expenditure_date":"|"receipt_date":"(?=.+?,"expenditure_date":null)
TIME_FORMAT = %F
MAX_TIMESTAMP_LOOKAHEAD = 10
MAX_DAYS_AGO = 10951
TRANSFORMS-0 = fec_schedule_e_drop_events
SEDCMD-0 = s/"}],".+$/"}/

EXTRACT-0 = (?&lt;candidate&gt;\w+)_schedule in source
KV_MODE = json</pre>
<pre># transforms.conf
[fec_schedule_e_drop_events]
REGEX = [^}]$
DEST_KEY = queue
FORMAT = nullQueue</pre>
                <p>With these settings, we let Splunk monitor the file created by the Python script. Whenever the script updates new transactions to the file, Splunk will automatically ingest it. In Splunk we receive one event as one transaction in valid JSON and the time of the event is set to <code>expenditure_date</code> (or <code>receipt_date</code> if the former is null). Since the events are in JSON, Splunk automatically parses the data as well:</p>
                <div class="center text-center" style="width: 500px">
                    <a href="#" class="img-pop">
                        <img src="/images/splunk_events_small.png" data-src="/images/splunk_events.png" style="max-height: 100%; max-width: 100%">
                    </a>
                    <p class="small">Click to enlarge</p>
                </div>
                <p>The raw event for the image above is:</p>
<pre>{"candidate_office":"P","office_total_ytd":773609.49,"notary_sign_date":null,"dissemination_date":"2016-08-19","candidate":{"candidate_id":"P80001571","two_year_period":2016.0,"idx":71849},"pdf_url":"http:\/\/docquery.fec.gov\/cgi-bin\/fecimg\/?201608199022591132","payee_middle_name":null,"candidate_prefix":null,"payee_last_name":null,"report_type":"48","load_date":"2016-08-19T23:26:19+00:00","record_number":null,"receipt_date":"2016-08-19","notary_sign_name":null,"independent_sign_name":"SCHIFELING, DEIRDRE","filing_form":"F24","expenditure_date":"2016-08-19","election_type":"G2016","line_number":"24","candidate_middle_name":null,"filer_middle_name":null,"category_code":"004","candidate_suffix":null,"payee_zip":"94104","tran_id":"B623462","payee_state":"CA","file_number":1095966,"committee":{"state_full":null,"committee_type_full":"Super PAC (Independent Expenditure-Only)","organization_type_full":null,"expire_date":"2016-03-19T00:37:18+00:00","zip":"10038","street_2":null,"cycles":[2016,2010,2014,2012],"treasurer_name":"GUSTAFSON, LIZ","city":"NEW YORK","cycle":2016,"party":null,"party_full":null,"designation_full":"Unauthorized","name":"PLANNED PARENTHOOD VOTES","committee_id":"C00489799","street_1":"123 WILLIAM ST, 10TH FLOOR","committee_type":"O","state":"NY","designation":"U","organization_type":null,"candidate_ids":[]},"election_type_full":null,"notary_commission_expiration_date":null,"payee_prefix":null,"is_notice":true,"image_number":"201608199022591132","sched_e_sk":312466902,"back_reference_schedule_name":null,"back_reference_transaction_id":null,"payee_first_name":null,"filer_suffix":null,"update_date":null,"filer_prefix":null,"committee_id":"C00489799","payee_city":"SAN FRANCISCO","link_id":4081920161313050011,"support_oppose_indicator":"O","filer_last_name":"SCHIFELING","payee_suffix":null,"candidate_id":"P80001571","payee_name":"TERRIS BARNES &amp; WALTERS","cand_office_state":"US","candidate_first_name":"DONALD","category_code_full":null,"expenditure_amount":1732.67,"payee_street_2":null,"expenditure_description":"CANVASS LIT-ESTIMATED COSTS","candidate_last_name":"TRUMP","report_primary_general":null,"filer_first_name":"DEIRDRE","cand_office_district":null,"committee_name":null,"payee_street_1":"400 MONTGOMERY ST # 700","report_year":2016,"independent_sign_date":"2016-08-19","candidate_name":"TRUMP, DONALD"}</pre>
                <p>The next challenge is performance and stability on serving the Splunk data to the public. We don't want the site visitors to overload the Splunk server by running searches to retrieve the FEC results on every page visit. Also since the Schedule E data only updates every day or so, we needed a way to <i>cache</i> the results. Fortunately Nginx can easily cache files, therefore we wrote another Python script that uses the <a href="http://dev.splunk.com/python">Splunk Python SDK</a> to run various searches against the Splunk server and save the results as a file on the web server. The script runs every day. The following are Splunk searches that the script runs and its current result:</p>
                <p class="small text-center">All searches are from May 1st, 2015 to now</p>
<pre>index=fec sourcetype=fec_schedule_e committee_id=*
| stats sum(expenditure_amount) as spent by committee_id committee.committee_type_full committee.name support_oppose_indicator candidate
| eval spent=round(spent)
| eval toward=if(support_oppose_indicator="O", "opposing", "supporting")
| sort 0 -spent
| streamstats count as rank by toward candidate
| eval id=if(rank&lt;=5, 'committee.name', "others ".toward." ".candidate)
| eval committee.committee_type_full=if(rank&lt;=5, 'committee.committee_type_full', "none")
| stats sum(spent) as spent by id committee.committee_type_full toward candidate
| rename id as committee.name</pre>
                <p class="small text-center">Result for the above: <a href="/data/schedule_e_stats.json">schedule_e_stats.json</a></p>
<pre>index=fec sourcetype=fec_schedule_e committee_id=*
| eval spent=round(expenditure_amount)
| eval toward=if(support_oppose_indicator="O", "opposing", "supporting")
| eval id=candidate."_".toward
| timechart span=1w sum(spent) by id
| fillnull
</pre>
                <p class="small text-center">Result for the above: <a href="/data/schedule_e_timechart.json">schedule_e_timechart.json</a> (currently not used)</p>
<pre>index=fec sourcetype=fec_schedule_e committee_id=*
| head 1
| table _time
| eval now=now()</pre>
                <p class="small text-center">Result for the above: <a href="/data/schedule_e_latest.json">schedule_e_latest.json</a></p>
                <p>Because we can't control the JSON response format of the OpenFEC API response, we added <code>committee_id=*</code> to potentially filter out any invalid JSON events in Splunk. In the past when the response format changed, we would get a few "stray" events that the regular expression in <code>props.conf</code> didn't catch.</p>
                <p>The Python script also calls the <a href="http://elections.huffingtonpost.com/pollster/api">Huffington Post API</a> for the 2016 Presidential Election poll results which is saved as <a href="/data/polls.json">polls.json</a> (also currently not used). The original idea was to correlate poll results with Schedule E spending over time. That functionality may be available in subsequent versions.</p>
                <p>With the data available, we developed a custom visualization called "Halo" in <a href="https://d3js.org/">d3.js</a> v4 that represents two sets of pie charts with a visual relationship between the two sets. The Halo visualization uses the following d3 libraries to compute the pie charts layout:</p>
                <ul>
                    <li><a href="https://github.com/d3/d3-shape/blob/master/README.md#pie">d3.pie()</a> and <a href="https://github.com/d3/d3-shape/blob/master/README.md#arc">d3.arc()</a> for the pie charts</li>
                    <li><a href="https://github.com/d3/d3-hierarchy/blob/master/README.md#hierarchy">d3.hierarchy()</a> and <a href="https://github.com/d3/d3-hierarchy/blob/master/README.md#pack">d3.pack()</a> for inner pie charts position and size</li>
                    <li><a href="https://github.com/d3/d3/blob/master/API.md#paths-d3-path">d3.path()</a> for the ribbons between the outer and inner pie charts</li>
                    <li><a href="https://github.com/d3/d3-transition">d3.transition()</a> for the smooth animation among "both", "supporting", and "opposing" expenditures</li>
                </ul>
                <p>In the d3 code, we heavily rely on <a href="http://underscorejs.org/">underscore.js</a> to further parse the JSON to a format that d3 likes. We use <a href="https://jquery.com/">jQuery</a> to do some minor DOM manipulation and <a href="http://getbootstrap.com/">Bootstrap</a> for the front-end design. We modified a Bootstrap theme called <a href="https://startbootstrap.com/template-overviews/grayscale/">Grayscale</a> for this page. Lastly we use <a href="http://requirejs.org/">RequireJS</a> to manage all the JavaScript libraries and to load the JSON files on the web server only once (as opposed to loading the same data for different visualizations).</p>
            </div>
        </div>
    </section>

    <section id="contact" class="container content-section text-center more-padding-bottom">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2">
                <h2>Contact Splunk</h2>
                <p>Interested in learning more about Splunk and Splunk4Good? Visit us <a href="http://www.splunk.com/">online</a> or <a href="https://www.splunk.com/en_us/about-us/contact.html">contact Splunk</a> to learn more or to inquire about our products and solutions.</p>
                <ul class="list-inline banner-social-buttons">
                    <li>
                        <a href="https://twitter.com/splunk" class="btn btn-default btn-lg"><i class="fa fa-twitter fa-fw"></i> <span class="network-name">Splunk Twitter</span></a>
                    </li>
                </ul>
            </div>
        </div>
    </section>

    <footer>
        <div class="container text-center">
            <p>© 2016 - Site powered by <a href="http://www.splunk.com/">Splunk</a>. Data provided by the <a href="https://beta.fec.gov/">Federal Election Commission</a> and the <a href="http://elections.huffingtonpost.com/pollster/api">Huffington Post</a>. Original Grayscale theme by <a href="http://blackrockdigital.io/">Blackrock Digital</a>.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js"></script>
    <script>
        require.config({
            shim: {
                "bootstrap": {
                    "deps": ["jquery"]
                },
                "jquery_easing": {
                    "deps": ["jquery"],
                    "export": "jQuery.easing"
                }
            },
            paths: {
                "d3": "//d3js.org/d3.v4.min",
                "underscore": "//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min",
                "jquery": "//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min",
                "jquery_easing": "//cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min",
                "bootstrap": "//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min",
                "moment": "//cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min"
            }
        });
    </script>
    <script src="/js/grayscale.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>
